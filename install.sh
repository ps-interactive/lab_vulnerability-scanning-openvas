#!/usr/bin/env bash

USER=vanilla
# Default password for OpenVAS
PASSWORD=pluralsight

# Always overcommit memory (use virtual memory)
sudo sysctl vm.overcommit_memory=1
grep -q "^vm.overcommit_memory" /etc/sysctl.conf || echo "vm_overcommit_memory = 1" | sudo tee -a /etc/sysctl.conf

cd docker || exit
# Start the Greenbone framework
sudo docker-compose up --detach

# Wait until gvmd is running, which we need to change the default passwords
while [[ $(sudo docker inspect -f '{{.State.Running}}' "gvmd" 2>/dev/null) != "true" ]]; do
    sleep 1
done
echo gvmd ready

# Ensure that we can create / set the admin password
while [[ $(sudo docker logs gvmd 2>/dev/null | grep -q "Modifying user password"; echo $?) -ne 0 ]]; do
    sudo docker compose exec -u gvmd gvmd gvmd --create-user=admin --password="$PASSWORD"
    sudo docker compose exec -u gvmd gvmd gvmd --user=admin --new-password="$PASSWORD"
    sleep 1
done
echo password set successfully

